@page
@model PRN222_FinalProject.Pages.Auctions.DetailsModel
@{
    ViewData["Title"] = "Chi tiết đấu giá";
}

<div class="container mt-4">
    @if (Model.Auction != null)
    {
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Auctions/Index">Đấu giá</a></li>
                <li class="breadcrumb-item active">@Model.Auction.ProductName</li>
            </ol>
        </nav>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show">
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <img src="@(Model.Auction.ProductImage ?? "/images/no-image.png")" class="card-img-top" alt="@Model.Auction.ProductName" style="max-height: 400px; object-fit: cover;">
                    <div class="card-body">
                        <h3>@Model.Auction.ProductName</h3>
                        <p class="text-muted"><i class="bi bi-person"></i> Người bán: @Model.Auction.SellerName</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header @(Model.Auction.Status == "closed" ? "bg-success" : Model.Auction.IsExpired ? "bg-secondary" : "bg-primary") text-white">
                        <h5 class="mb-0">
                            @if (Model.Auction.Status == "closed")
                            {
                                <i class="bi bi-check-circle"></i> <text>Đã chốt</text>
                            }
                            else if (Model.Auction.IsExpired)
                            {
                                <i class="bi bi-clock-history"></i> <text>Đã hết hạn</text>
                            }
                            else
                            {
                                <i class="bi bi-hammer"></i> <text>Đang đấu giá</text>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Giá khởi điểm:</small>
                            <h5>@Model.Auction.StartingPrice.ToString("N0") VND</h5>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Giá hiện tại:</small>
                            <h3 class="text-primary current-price">@(Model.Auction.CurrentPrice?.ToString("N0") ?? Model.Auction.StartingPrice.ToString("N0")) VND</h3>
                        </div>

                        @if (Model.Auction.ReservePrice.HasValue)
                        {
                            <div class="mb-3">
                                <small class="text-muted">Giá dự trữ:</small>
                                <p class="mb-0">@Model.Auction.ReservePrice.Value.ToString("N0") VND</p>
                            </div>
                        }

                        <div class="mb-3">
                            <small class="text-muted">Bước giá:</small>
                            <p class="mb-0">@Model.Auction.BidIncrement.ToString("N0") VND</p>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted"><i class="bi bi-people"></i> Số lượt đặt giá:</small>
                            <h5 class="total-bids">@Model.Auction.TotalBids lượt</h5>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <small class="text-muted">Thời gian bắt đầu:</small>
                            <p class="mb-0">@Model.Auction.StartTime.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Thời gian kết thúc:</small>
                            <p class="mb-0">@Model.Auction.EndTime.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>

                        @if (!Model.Auction.IsExpired && Model.Auction.Status == "active")
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-clock"></i> 
                                <strong>Thời gian còn lại: </strong>
                                @if (Model.Auction.TimeRemaining.Days > 0)
                                {
                                    <span>@Model.Auction.TimeRemaining.Days ngày @Model.Auction.TimeRemaining.Hours giờ @Model.Auction.TimeRemaining.Minutes phút</span>
                                }
                                else if (Model.Auction.TimeRemaining.Hours > 0)
                                {
                                    <span>@Model.Auction.TimeRemaining.Hours giờ @Model.Auction.TimeRemaining.Minutes phút</span>
                                }
                                else
                                {
                                    <span>@Model.Auction.TimeRemaining.Minutes phút @Model.Auction.TimeRemaining.Seconds giây</span>
                                }
                            </div>
                        }

                        @if (Model.Auction.Status == "closed" && Model.Auction.WinnerName != null)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-trophy"></i> <strong>Người thắng cuộc:</strong> @Model.Auction.WinnerName
                            </div>
                        }
                    </div>
                </div>

                @if (Model.CurrentUser != null && Model.CurrentUser.Id != Model.Auction.SellerId && !Model.Auction.IsExpired && Model.Auction.Status == "active")
                {
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Đặt giá</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" asp-page-handler="PlaceBid">
                                <input type="hidden" asp-for="PlaceBidDto.AuctionId" value="@Model.Auction.Id" />
                                
                                <div class="mb-3">
                                    <label asp-for="PlaceBidDto.BidAmount" class="form-label">Số tiền đặt giá (VND) <span class="text-danger">*</span></label>
                                    <input asp-for="PlaceBidDto.BidAmount" type="number" class="form-control form-control-lg" min="@((Model.Auction.CurrentPrice ?? Model.Auction.StartingPrice) + Model.Auction.BidIncrement)" 
                                           oninvalid="this.setCustomValidity('Vui lòng nhập giá trị lớn hơn hoặc bằng @(((Model.Auction.CurrentPrice ?? Model.Auction.StartingPrice) + Model.Auction.BidIncrement).ToString("N0")) VND')"
                                           oninput="this.setCustomValidity('')" />
                                    <span asp-validation-for="PlaceBidDto.BidAmount" class="text-danger"></span>
                                    <small class="text-muted bid-help-text">Giá phải tăng ít nhất @Model.Auction.BidIncrement.ToString("N0") VND. Giá tối thiểu: @(((Model.Auction.CurrentPrice ?? Model.Auction.StartingPrice) + Model.Auction.BidIncrement).ToString("N0")) VND</small>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-hammer"></i> Đặt giá ngay
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else if (Model.CurrentUser == null)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <a asp-page="/Account/Login">Đăng nhập</a> để tham gia đấu giá
                    </div>
                }
                else if (Model.CurrentUser.Id == Model.Auction.SellerId)
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Bạn là người bán, không thể đặt giá
                    </div>
                }
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ol"></i> Lịch sử đặt giá (@Model.Bids?.Count() ?? 0 lượt)</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Bids != null && Model.Bids.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Người đặt giá</th>
                                            <th>Số tiền</th>
                                            <th>Thời gian</th>
                                            <th>Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var bid in Model.Bids)
                                        {
                                            <tr class="@(bid.IsWinning ? "table-success" : "")">
                                                <td>
                                                    @bid.BidderName
                                                    @if (bid.IsWinning)
                                                    {
                                                        <span class="badge bg-success ms-2">Đang dẫn đầu</span>
                                                    }
                                                </td>
                                                <td><strong>@bid.BidAmount.ToString("N0") VND</strong></td>
                                                <td>@bid.BidTime.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                                <td>
                                                    @if (bid.IsWinning)
                                                    {
                                                        <i class="bi bi-trophy text-success"></i>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center">Chưa có lượt đặt giá nào</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Đấu giá không tồn tại
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        // Use IIFE to avoid global variable conflicts
        (function() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

        // Connection events
        connection.onreconnecting(error => {
            console.error("SignalR đang kết nối lại:", error);
        });

        connection.onreconnected(connectionId => {
            console.log("SignalR đã kết nối lại với ID:", connectionId);
        });

        connection.onclose(error => {
            console.error("SignalR đã đóng kết nối:", error);
        });

        // Start connection
        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR đã kết nối thành công");
                console.log("ID kết nối:", connection.connectionId);
                console.log("ID đấu giá hiện tại:", @Model.Auction.Id);
                
                // Test connection by subscribing to auction-specific group
                await connection.invoke("JoinAuctionGroup", @Model.Auction.Id);
                console.log("Đã tham gia nhóm đấu giá ID:", @Model.Auction.Id);
                
                // Re-establish all listeners after connection
                setupSignalRListeners();
                
            } catch (err) {
                console.error("Lỗi kết nối SignalR:", err);
                setTimeout(startConnection, 5000);
            }
        }

        // Setup all SignalR listeners
        function setupSignalRListeners() {
            // Listen for auction updates
            connection.on("ReceiveAuctionUpdate", function (auctionId, data) {
                // Convert data types if needed
                const currentPrice = Number(data.currentPrice);
                const totalBids = Number(data.totalBids);
                const lastBidAmount = Number(data.lastBidAmount);
                
                // Only update if this is the current auction
                if (auctionId === @Model.Auction.Id) {
                    // Try to update current price with multiple selectors
                    const priceSelectors = [
                        '.current-price',
                        'h3.current-price',
                        '.text-primary.current-price'
                    ];
                    
                    let priceElement = null;
                    for (const selector of priceSelectors) {
                        priceElement = document.querySelector(selector);
                        if (priceElement) {
                            break;
                        }
                    }
                    
                    if (priceElement) {
                        const newPriceText = currentPrice.toLocaleString('vi-VN') + ' VND';
                        priceElement.textContent = newPriceText;
                        
                        // Force visual update
                        priceElement.style.color = 'red';
                        setTimeout(() => {
                            priceElement.style.color = '';
                        }, 1000);
                    }
                    
                    // Try to update total bids with multiple selectors
                    const bidsSelectors = [
                        '.total-bids',
                        'h5.total-bids'
                    ];
                    
                    let bidsElement = null;
                    for (const selector of bidsSelectors) {
                        bidsElement = document.querySelector(selector);
                        if (bidsElement) {
                            break;
                        }
                    }
                    
                    if (bidsElement) {
                        const newBidsText = totalBids + ' lượt';
                        bidsElement.textContent = newBidsText;
                        
                        // Force visual update
                        bidsElement.style.color = 'blue';
                        setTimeout(() => {
                            bidsElement.style.color = '';
                        }, 1000);
                    }
                    
                    // Show notification
                    showNotification(`Có người mới đặt giá ${lastBidAmount.toLocaleString('vi-VN')} VND!`, 'info');
                    
                    // Refresh only the bids list, not the whole page
                    refreshBidsList();
                }
            });

            // Listen for any message to test connection
            connection.on("AnyMessage", function (message) {
                showNotification("Tin nhắn test: " + message, "success");
            });

            // Listen for test response
            connection.on("TestResponse", function (message) {
                showNotification("Test SignalR: " + message, "success");
            });

            connection.on("PlaceBidResponse", async function (response) {
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Đặt giá thành công!', 'success');
                        // The UI will update automatically via SignalR
                    } else {
                        showNotification(result.message || 'Đặt giá thất bại', 'danger');
                    }
                } else {
                    showNotification('Lỗi khi đặt giá', 'danger');
                }
            });
        }

        // Initialize connection and listeners
        setupSignalRListeners();
        startConnection();

        // Test button to manually trigger SignalR update
        function testSignalR() {
            // First, test if elements exist
            const priceElement = document.querySelector('.current-price');
            const bidsElement = document.querySelector('.total-bids');
            
            // Test hub connection first
            connection.invoke("TestConnection")
                .then(() => console.log("Test kết nối hub thành công"))
                .catch(err => console.error("Lỗi test kết nối hub:", err));
            
            // Test simple message
            connection.invoke("SendTestMessage")
                .then(() => console.log("Đã gửi tin nhắn test"))
                .catch(err => console.error("Lỗi gửi tin nhắn test:", err));
            
            // Simulate an auction update with simple data
            const testData = {
                currentPrice: @Model.Auction.CurrentPrice ?? @Model.Auction.StartingPrice,
                totalBids: @Model.Auction.TotalBids,
                lastBidAmount: 1000000,
                lastBidTime: new Date().toLocaleString('vi-VN')
            };
            
            // Manually trigger the update function
            connection.invoke("SendAuctionUpdate", @Model.Auction.Id, testData)
                .then(() => console.log("Đã gửi cập nhật đấu giá test"))
                .catch(err => console.error("Lỗi gửi cập nhật đấu giá test:", err));
        }

        // Add test button to the page
        document.addEventListener('DOMContentLoaded', function() {
            const testBtn = document.createElement('button');
            testBtn.textContent = 'Test SignalR';
            testBtn.className = 'btn btn-sm btn-info mt-2';
            testBtn.onclick = testSignalR;
            testBtn.style.position = 'fixed';
            testBtn.style.bottom = '20px';
            testBtn.style.right = '20px';
            testBtn.style.zIndex = '9999';
            document.body.appendChild(testBtn);
        });

        // Function to refresh only the bids list
        function refreshBidsList() {
            const auctionId = @Model.Auction.Id;
            const url = window.location.pathname + '?handler=BidsList&id=' + auctionId;
            
            // Find the anti-forgery token
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenElement ? tokenElement.value : '';
            
            const fetchOptions = {
                method: 'GET'
            };
            
            // Only add token if found
            if (token) {
                fetchOptions.headers = {
                    'RequestVerificationToken': token
                };
            }
            
            fetch(url, fetchOptions)
            .then(response => response.text())
            .then(html => {
                // The partial view returns ONLY the tbody content
                const currentBidsTable = document.querySelector('table tbody');
                
                if (currentBidsTable) {
                    // Directly replace the tbody content with the returned HTML
                    currentBidsTable.innerHTML = html;
                    
                    // Force visual update
                    currentBidsTable.style.backgroundColor = 'yellow';
                    setTimeout(() => {
                        currentBidsTable.style.backgroundColor = '';
                    }, 1000);
                }
            })
            .catch(error => console.error('Lỗi làm mới danh sách đặt giá:', error));
        }

        // Helper function to show notifications
        function showNotification(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        connection.start().catch(err => console.error("Lỗi kết nối SignalR: ", err));
        })(); // End IIFE
    </script>
}
